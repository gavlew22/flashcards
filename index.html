<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Chinese Flashcard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <body>
    <div class="row" id="top-controls-row">
      <button onclick="window.location.href='settings.html'">Settings</button>
      <button id="shuffleBtn">Shuffle</button>
      <button id="resetBtn" style="display: none;">Reset Order</button>

    </div>

    <div class="row" id="row-info-row">
      <div id="rowInfo">Loading...</div>
      <div> &nbsp;&nbsp;&nbsp;&nbsp;Version 12 </div>
    </div>

    <div class="row" id="question-row">
      <div id="question"></div>
    </div>

    <div class="row" id="answer-row">
      <div id="answer"></div>
    </div>

    <!-- Wrap the answer and navigation buttons -->
    <div id="bottom-controls-wrapper">
      <div class="row" id="answer-button-row">
        <button id="showAnswerBtn">Show Answer</button>
      </div>

      <div class="row" id="navigation-buttons-row">
        <button id="backBtn">Back</button>
        <button id="nextBtn">Next</button>
      </div>
    </div>


    <!-- loads the config.js file which contains the sheetJsonUrl -->
    <script src="config.js"></script>

    <script>
      const questionColumns = ["English"];
      const answerColumns = ["pinyinWithNumbers", "Chinese", "Mnemonic"];

      let data = [];
      let currentIndex = 0;
      let answerVisible = false;

      function displayWord() {
        const row = data[currentIndex];

        // Create question text
        const questionHtml = questionColumns.map(col => `<h2>${row[col]}</h2>`).join("");
        document.getElementById("question").innerHTML = questionHtml;

        // Create answer text
        const answerHtml = answerColumns.map(col => `<p>${row[col]}</p>`).join("");
        document.getElementById("answer").innerHTML = answerHtml;

        // Row indicator
        document.getElementById("rowInfo").innerText = `${currentIndex + 1} of ${data.length}`;

        // Set answer visibility
        document.getElementById("answer").style.display = answerVisible ? "block" : "none";
      }
      // Load the shuffled data from localStorage if available 
      const savedData = localStorage.getItem("flashcardData");

      // Check if we have saved data and hide appropriate button
      if (savedData) {
        document.getElementById("resetBtn").style.display = "inline-block";
        document.getElementById("shuffleBtn").style.display = "none";
      } else {
        document.getElementById("resetBtn").style.display = "none";
        document.getElementById("shuffleBtn").style.display = "inline-block";
      }

      if (savedData) {
        // check if there is saved data in localStorage
        data = JSON.parse(savedData);
        displayWord();
      } else {
        // Fall back to default order from Google Sheet
        if (navigator.onLine) {
          // Try to fetch latest data if online
          fetch(sheetJsonUrl)
            .then(response => response.json())
            .then(json => {
              data = json;
              localStorage.setItem("offlineData", JSON.stringify(json)); // Save to local storage
              displayWord();
            })
            .catch(error => {
              console.error("Fetch error:", error);
              loadFromLocal(); // Fallback if fetch fails
            });
        } else {
          // Offline mode: load from localStorage
          loadFromLocal();
        }

        function loadFromLocal() {
          const cached = localStorage.getItem("offlineData");
          if (cached) {
            data = JSON.parse(cached);
            displayWord();
          } else {
            document.getElementById("question").innerText = "Offline data not available.";
          }
        }

      }


      document.getElementById("nextBtn").addEventListener("click", () => {
        currentIndex++;
        if (currentIndex >= data.length) {
          currentIndex = 0;
        }
        answerVisible = false;
        displayWord();
      });

      document.getElementById("backBtn").addEventListener("click", () => {
        currentIndex--;
        if (currentIndex < 0) {
          currentIndex = data.length - 1;
        }
        answerVisible = false;
        displayWord();
      });

      document.getElementById("showAnswerBtn").addEventListener("click", () => {
        answerVisible = true;
        displayWord();
      });


      // Shuffling the cards
      function shuffleArray(array) {
        return [...array].sort(() => Math.random() - 0.5);
      }

      // Shuffle button handler
      document.getElementById("shuffleBtn").addEventListener("click", () => {
        fetch(sheetJsonUrl)
          .then(res => res.json())
          .then(json => {
            const shuffled = shuffleArray(json);
            localStorage.setItem("flashcardData", JSON.stringify(shuffled));
            data = shuffled;
            currentIndex = 0;
            answerVisible = false;
            displayWord();

            // Hide shuffle, show reset
            document.getElementById("shuffleBtn").style.display = "none";
            document.getElementById("resetBtn").style.display = "inline-block";
          })
          .catch(err => {
            console.error(err);
          });
      });


      // Reset button handler
      document.getElementById("resetBtn").addEventListener("click", () => {
        localStorage.removeItem("flashcardData");
        fetch(sheetJsonUrl)
          .then(res => res.json())
          .then(json => {
            data = json;
            currentIndex = 0;
            answerVisible = false;
            displayWord();

            // Hide reset, show shuffle
            document.getElementById("resetBtn").style.display = "none";
            document.getElementById("shuffleBtn").style.display = "inline-block";
          })
          .catch(err => {
            console.error(err);
          });
      });

      // Fix 100vh for mobile browsers with dynamic toolbars
      function updateVh() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh * 100}px`);
      }

      // Initial call and on resize
      updateVh();
      window.addEventListener('resize', updateVh);


    </script>
  </body>

</html>